<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>Timinute</title>
    <link rel="stylesheet" href="../css/header.css" />
    <link rel="stylesheet" href="../css/AttendanceManagement.css" />
</head>

<body>

<header class="header">
    <div class="logo-container">
      <img src="../image/Timinute_logo.png" alt="ç”»åƒ" />
    </div>
    <div class="welcome-text">
      <p>ãŠç–²ã‚Œæ§˜ã§ã™ï¼<br />ç®¡ç†è€…ã•ã‚“</p>
    </div>
    <div class="buttons">
		<a href="/adminhome"><button class="headerbtn">HOME</button></a>
		<form th:action="@{/logout}" method="post" style="display: inline;">
			<button class="headerbtn" type="submit">Logout</button>
		</form>
    </div>
</header>

<div class="whole">
  <main>
    <div class="search-box">
      <form>
        <div class="searchcontent">
          <label>
            <span class="label-text">éƒ¨ç½²</span>
            <select id="department">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="1">å–¶æ¥­</option>
              <option value="2">é–‹ç™º</option>
              <option value="0">ç·å‹™</option>
            </select>
          </label>
        </div>

        <div class="searchcontent">
          <label>
            <span class="label-text">å½¹è·</span>
            <select id="position">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="0">ç¤¾é•·</option>
              <option value="1">éƒ¨é•·</option>
              <option value="2">èª²é•·</option>
              <option value="3">ä¿‚é•·</option>
              <option value="4">ä¸€èˆ¬</option>
            </select>
          </label>
        </div>

        <div class="searchcontent">
          <label>
            <span class="label-text">ç¤¾å“¡ID</span>
            <input type="text" id="employee-id" />
          </label>
        </div>

        <div class="searchcontent">
          <label>
            <span class="label-text">æœŸé–“</span>
            <input type="date" id="start-date" /> ã€œ <input type="date" id="end-date" />
          </label>
        </div>
      </form>
<button type="button" class="search-btn" id="search-btn">æ¤œç´¢</button>
    </div>

    <div class="explanation">
      <p><b>æ¤œç´¢èª¬æ˜</b></p>
      <ul class="textcontent">
        <li>å„é …ç›®ã‚’è¨­å®šã€€ï¼šæŒ‡å®šã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</li>
        <li>æœŸé–“æœªå…¥åŠ›ã€€ã€€ï¼šå‰1ã‚«æœˆã®ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤º</li>
        <li>å…¨é …ç›®ãŒæœªå…¥åŠ›ï¼šå‰1ã‚«æœˆã®å…¨ç¤¾å“¡ã®ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤º</li>
      </ul>
    </div>
  </main>

   <!-- æ¤œç´¢çµæœè¡¨ç¤ºã€‚æœ€åˆã¯éè¡¨ç¤º -->
<div id="results" style="display:none;">
  <h2>æ¤œç´¢çµæœ</h2>
  <table id="results-table">
  <thead>
	<tr>
	  <th>ç¤¾å“¡ID</th>
	  <th>åå‰</th>
	  <th>éƒ¨ç½²</th>
	  <th>å½¹è·</th>
	  <th>æ—¥ä»˜</th>
	  <th>å§‹æ¥­æ™‚é–“</th>
	  <th>çµ‚æ¥­æ™‚é–“</th>
	  <th>åŠ´åƒæ™‚é–“</th>
	  <th>ä¼‘æ†©æ™‚é–“</th>
	  <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
	  <th>ç·¨é›†</th>
	  <th>ç¢ºå®š</th>
	</tr>
  </thead>

  <tbody></tbody>
</table>

<div class="buttons-container">
    <button id="edit-btn" class="small-btn" style="display:none;">ç·¨é›†</button>
    <button id="confirm-btn" class="small-btn" style="display:none;">ç¢ºå®š</button>
  </div>

  <button id="output-btn" class="search-btn" style="display:none;">å‡ºåŠ›</button>
</div>

</div>
</div>



<script>
	const departmentMap = {
	  "0": "ç·å‹™",
	  "1": "å–¶æ¥­",
	  "2": "é–‹ç™º"
	};

	const positionMap = {
	  "0": "ç¤¾é•·",
	  "1": "éƒ¨é•·",
	  "2": "èª²é•·",
	  "3": "ä¿‚é•·",
	  "4": "ä¸€èˆ¬"
	};
	
document.getElementById("search-btn").addEventListener("click", function () {
  console.log("âœ… æ¤œç´¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");

  const department = document.getElementById("department").value.trim();
  const position = document.getElementById("position").value.trim();
  const employeeId = document.getElementById("employee-id").value.trim();
  let startDate = document.getElementById("start-date").value;
  let endDate = document.getElementById("end-date").value;

  // æœŸé–“è£œå®Œ
  if (!startDate || !endDate) {
    const today = new Date();
    const firstDayLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const lastDayLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);

    const formatDate = (d) => d.toLocaleDateString('sv-SE');
    startDate = formatDate(firstDayLastMonth);
    endDate = formatDate(lastDayLastMonth);
  }

  console.log("âœ… å…¥åŠ›å€¤:");
  console.log("éƒ¨ç½²:", department);
  console.log("å½¹è·:", position);
  console.log("ç¤¾å“¡ID:", employeeId);
  console.log("é–‹å§‹æ—¥:", startDate);
  console.log("çµ‚äº†æ—¥:", endDate);

  // fetché–‹å§‹
  console.log("ğŸ“¡ ã‚µãƒ¼ãƒãƒ¼ã¸fetchãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡");

  fetch("/attendance/adminsearch", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      department,
      position,
      employeeId,
      startDate,
      endDate
    })
  })
    .then(response => {
      console.log("ğŸ“¥ ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡ status:", response.status);
      if (!response.ok) {
        throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("âœ… JSONå¤‰æ›å®Œäº† data:", data);
      console.log("typeof data:", typeof data);
      console.log("Array.isArray(data):", Array.isArray(data));

      if (!Array.isArray(data)) {
        throw new Error("âŒ ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼ï¼šé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
      }

      const resultsDiv = document.getElementById("results");
      const tbody = document.querySelector("#results-table tbody");
      tbody.innerHTML = "";
      console.log("ğŸ“„ è¡¨ tbody ã‚¯ãƒªã‚¢æ¸ˆã¿");

      if (data.length === 0) {
        console.log("âš ï¸ ãƒ‡ãƒ¼ã‚¿ãªã—");
        tbody.innerHTML = `<tr><td colspan="12">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
      } else {
        console.log(`âœ… ${data.length} ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æç”»é–‹å§‹`);
        data.forEach(record => {
          console.log("ğŸ“Œ record:", record);

          const tr = document.createElement("tr");
          tr.setAttribute("data-employee-id", record.employeeId);

		  const isConfirmed = record.categoryStatus === true;
          tr.innerHTML = `
            <td>${record.employeeId}</td>
            <td>${record.name}</td>
			<td>${departmentMap[record.departmentId] || record.departmentId}</td>
			<td>${positionMap[record.jobId] || record.jobId}</td>
            <td>${record.date}</td>
            <td>${record.startTime}</td>
            <td>${record.closingTime}</td>
            <td>${record.workTime}</td>
            <td>${record.breakTime}</td>
            <td>${record.comment || ""}</td>
            <td><button class="edit-btn small-btn">ç·¨é›†</button></td>
			<td>
			  <button class="confirm-btn small-btn" ${isConfirmed ? "disabled" : ""}>
			    ${isConfirmed ? "ç¢ºå®šæ¸ˆ" : "ç¢ºå®š"}
			  </button>
			</td>
          `;
          tbody.appendChild(tr);
        });

        console.log("âœ… è¡¨æç”»å®Œäº†");
      }

      resultsDiv.style.display = "block";
      document.getElementById("output-btn").style.display = "block";
      console.log("âœ… è¡¨ã¨å‡ºåŠ›ãƒœã‚¿ãƒ³è¡¨ç¤º");

      setTimeout(() => {
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', () => {
			const row = btn.closest('tr');
			const empId = row.cells[0].textContent.trim();         // ç¤¾å“¡ID
			const date = row.cells[4].textContent.trim();           // æ—¥ä»˜
			const startTime = row.cells[5].textContent.trim();      // å§‹æ¥­æ™‚é–“
			const closingTime = row.cells[6].textContent.trim();    // çµ‚æ¥­æ™‚é–“
			const workTime = row.cells[7].textContent.trim();       // åŠ´åƒæ™‚é–“
			const breakTime = row.cells[8].textContent.trim();      // ä¼‘æ†©æ™‚é–“
			
			const url = `/attendance/edit?employeeId=${encodeURIComponent(empId)}`
			          + `&date=${encodeURIComponent(date)}`
			          + `&startTime=${encodeURIComponent(startTime)}`
			          + `&closingTime=${encodeURIComponent(closingTime)}`
			          + `&workTime=${encodeURIComponent(workTime)}`
					  + `&breakTime=${encodeURIComponent(breakTime)}`;  
	        console.log("ğŸ”— ç·¨é›†ãƒœã‚¿ãƒ³: é·ç§»å…ˆURL:", url);
            window.location.href = url;
          });
        });
		
		document.querySelectorAll('.confirm-btn').forEach(btn => {
		  btn.addEventListener('click', () => {
		    const row = btn.closest('tr');
		    const empId = row.cells[0].textContent.trim();
		    const date = row.cells[4].textContent.trim();

		    if (!confirm("ã“ã®å‹¤æ€ æƒ…å ±ã‚’ç¢ºå®šã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;

		    fetch("/attendance/approve", {
		      method: "POST",
		      headers: {
		        "Content-Type": "application/json"
		      },
		      body: JSON.stringify({
		        employeeId: empId,
		        date: date
		      })
		    })
		    .then(res => {
		      if (!res.ok) throw new Error("ç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ");
		      return res.text();
		    })
		    .then(msg => {
		      alert("ç¢ºå®šã—ã¾ã—ãŸï¼");
		      // ä»»æ„ã§ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ãªã©ï¼š
		      btn.disabled = true;
		      btn.textContent = "ç¢ºå®šæ¸ˆ";
		    })
		    .catch(err => {
		      console.error("âŒ ç¢ºå®šã‚¨ãƒ©ãƒ¼:", err);
		      alert("ç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
		    });
		  });
		});
      }, 0);
    })
    .catch(error => {
      console.error("âŒ æ¤œç´¢å¤±æ•—:", error);
      alert("æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚");
    });
});

document.getElementById("output-btn").addEventListener("click", function () {
  const table = document.getElementById("results-table");
  const rows = Array.from(table.querySelectorAll("tr"));

  let csvContent = "";

  rows.forEach((row, rowIndex) => {
    const cells = Array.from(row.querySelectorAll("th, td"));
    const rowData = cells.map(cell => {
      let text = cell.textContent.trim();
      // å¦‚æœå†…å®¹ä¸­æœ‰é€—å·æˆ–åŒå¼•å·ï¼Œéœ€è¦è½¬ä¹‰
      if (text.includes(",") || text.includes('"')) {
        text = '"' + text.replace(/"/g, '""') + '"';
      }
      return text;
    }).join(",");
    csvContent += rowData + "\n";
  });

  // åˆ›å»º blob å¯¹è±¡å¹¶ä¸‹è½½
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "attendance_export.csv";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});
</script>


</body>
</html>
