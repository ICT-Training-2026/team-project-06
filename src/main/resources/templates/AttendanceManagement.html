<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>Timinute</title>
    <link rel="stylesheet" href="../css/header.css" />
    <link rel="stylesheet" href="../css/AttendanceManagement.css" />
</head>

<body>

<header class="header">
    <div class="logo-container">
      <img src="../image/Timinute_logo.png" alt="画像" />
    </div>
    <div class="welcome-text">
      <p>お疲れ様です！<br />管理者さん</p>
    </div>
    <div class="buttons">
      <a href="userhome.html"><button class="headerbtn">HOME</button></a>
      <a href="login.html"><button class="headerbtn">Logout</button></a>
    </div>
</header>

<div class="whole">
  <main>
    <div class="search-box">
      <form>
        <div class="searchcontent">
          <label>
            <span class="label-text">部署</span>
            <select id="department">
              <option value="">選択してください</option>
              <option value="1">営業</option>
              <option value="2">開発</option>
              <option value="0">総務</option>
            </select>
          </label>
        </div>

        <div class="searchcontent">
          <label>
            <span class="label-text">役職</span>
            <select id="position">
              <option value="">選択してください</option>
              <option value="0">社長</option>
              <option value="1">部長</option>
              <option value="2">課長</option>
              <option value="3">係長</option>
              <option value="4">一般</option>
            </select>
          </label>
        </div>

        <div class="searchcontent">
          <label>
            <span class="label-text">社員ID</span>
            <input type="text" id="employee-id" />
          </label>
        </div>

        <div class="searchcontent">
          <label>
            <span class="label-text">期間</span>
            <input type="date" id="start-date" /> 〜 <input type="date" id="end-date" />
          </label>
        </div>
      </form>
<button type="button" class="search-btn" id="search-btn">検索</button>
    </div>

    <div class="explanation">
      <p><b>検索説明</b></p>
      <ul class="textcontent">
        <li>各項目を設定　：指定されたデータを表示</li>
        <li>期間未入力　　：前1カ月のデータが表示</li>
        <li>全項目が未入力：前1カ月の全社員のデータが表示</li>
      </ul>
    </div>
  </main>

   <!-- 検索結果表示。最初は非表示 -->
<div id="results" style="display:none;">
  <h2>検索結果</h2>
  <table id="results-table">
  <thead>
	<tr>
	  <th>社員ID</th>
	  <th>名前</th>
	  <th>部署</th>
	  <th>役職</th>
	  <th>日付</th>
	  <th>始業時間</th>
	  <th>終業時間</th>
	  <th>労働時間</th>
	  <th>休憩時間</th>
	  <th>コメント</th>
	  <th>編集</th>
	  <th>確定</th>
	</tr>
  </thead>

  <tbody></tbody>
</table>

<div class="buttons-container">
    <button id="edit-btn" class="small-btn" style="display:none;">編集</button>
    <button id="confirm-btn" class="small-btn" style="display:none;">確定</button>
  </div>

  <button id="output-btn" class="search-btn" style="display:none;">出力</button>
</div>

</div>
</div>



<script>
document.getElementById("search-btn").addEventListener("click", function () {
  console.log("✅ 検索ボタンがクリックされました");

  const department = document.getElementById("department").value.trim();
  const position = document.getElementById("position").value.trim();
  const employeeId = document.getElementById("employee-id").value.trim();
  let startDate = document.getElementById("start-date").value;
  let endDate = document.getElementById("end-date").value;

  // 期間補完
  if (!startDate || !endDate) {
    const today = new Date();
    const firstDayLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    const lastDayLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);

    const formatDate = (d) => d.toLocaleDateString('sv-SE');
    startDate = formatDate(firstDayLastMonth);
    endDate = formatDate(lastDayLastMonth);
  }

  console.log("✅ 入力値:");
  console.log("部署:", department);
  console.log("役職:", position);
  console.log("社員ID:", employeeId);
  console.log("開始日:", startDate);
  console.log("終了日:", endDate);

  // fetch開始
  console.log("📡 サーバーへfetchリクエスト送信");

  fetch("/attendance/adminsearch", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      department,
      position,
      employeeId,
      startDate,
      endDate
    })
  })
    .then(response => {
      console.log("📥 レスポンス受信 status:", response.status);
      if (!response.ok) {
        throw new Error(`HTTPエラー: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log("✅ JSON変換完了 data:", data);
      console.log("typeof data:", typeof data);
      console.log("Array.isArray(data):", Array.isArray(data));

      if (!Array.isArray(data)) {
        throw new Error("❌ データ形式エラー：配列ではありません");
      }

      const resultsDiv = document.getElementById("results");
      const tbody = document.querySelector("#results-table tbody");
      tbody.innerHTML = "";
      console.log("📄 表 tbody クリア済み");

      if (data.length === 0) {
        console.log("⚠️ データなし");
        tbody.innerHTML = `<tr><td colspan="12">該当するデータがありません。</td></tr>`;
      } else {
        console.log(`✅ ${data.length} 件のデータを描画開始`);
        data.forEach(record => {
          console.log("📌 record:", record);

          const tr = document.createElement("tr");
          tr.setAttribute("data-employee-id", record.employeeId);

          tr.innerHTML = `
            <td>${record.employeeId}</td>
            <td>${record.name}</td>
            <td>${record.departmentId}</td>
            <td>${record.jobId}</td>
            <td>${record.date}</td>
            <td>${record.startTime}</td>
            <td>${record.closingTime}</td>
            <td>${record.workTime}</td>
            <td>${record.breakTime}</td>
            <td>${record.comment || ""}</td>
            <td><button class="edit-btn small-btn">編集</button></td>
            <td><button class="confirm-btn small-btn">確定</button></td>
          `;
          tbody.appendChild(tr);
        });

        console.log("✅ 表描画完了");
      }

      resultsDiv.style.display = "block";
      document.getElementById("output-btn").style.display = "block";
      console.log("✅ 表と出力ボタン表示");

      setTimeout(() => {
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const row = btn.closest('tr');
            const date = row.cells[4].textContent;
            const empId = row.getAttribute('data-employee-id');
            const url = `AttendanceEdit.html?date=${encodeURIComponent(date)}&id=${encodeURIComponent(empId)}`;
            console.log("🔗 編集ボタン: 遷移先URL:", url);
            window.location.href = url;
          });
        });
      }, 0);
    })
    .catch(error => {
      console.error("❌ 検索失敗:", error);
      alert("検索に失敗しました。サーバーまたはデータ形式に問題があります。");
    });
});
</script>


</body>
</html>
