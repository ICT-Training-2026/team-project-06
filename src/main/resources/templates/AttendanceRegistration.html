<!DOCTYPE html>
<html lang="jp">
<head>
    <meta charset="UTF-8">
    <title>Timinute</title>
	<link rel="stylesheet" th:href="@{/css/header.css}">
	<link rel="stylesheet" th:href="@{/css/AttendanceRegistration.css}">
</head>

<body>

<header class="header">
    <div class="logo-container">
      <img src="../image/Timinute_logo.png" alt="ç”»åƒ">
    </div>
    <div class="welcome-text">
      <p>ãŠç–²ã‚Œæ§˜ã§ã™ï¼<br>â—‹â—‹ã•ã‚“</p>
    </div>
    <div class="buttons">
		<a href="/userhome"><button class="headerbtn">HOME</button></a>
		<a href="/login"><button class="headerbtn">Logout</button></a>
    </div>
</header>

<div class="container">
    <div class="left-content">
        <div class="all">
            <div class="date" id="date"></div>
            <div class="time" id="time"></div>
        </div>
        <div class="category">
            <label>
                <input type="radio" name="option" value="0" checked>å‡ºå‹¤
            </label>
            <label>
                <input type="radio" name="option" value="1">æŒ¯å‡º
            </label>
        </div>
    </div>
	<div class="button-grid">
	    <button class="roundbtn" data-action="start">å‡ºå‹¤</button>
	    <button class="roundbtn" data-action="breakStart">ä¼‘æ†©é–‹å§‹</button>
	    <button class="roundbtn" data-action="breakEnd">ä¼‘æ†©çµ‚äº†</button>
	    <button class="roundbtn" data-action="end">é€€å‹¤</button>
	</div>
</div>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		console.log("âœ… DOMContentLoaded èµ·å‹•æˆåŠŸ");
	    const btns = {
	        clockIn: document.querySelector("[data-action='start']"),
	        breakStart: document.querySelector("[data-action='breakStart']"),
	        breakEnd: document.querySelector("[data-action='breakEnd']"),
	        clockOut: document.querySelector("[data-action='end']")
	    };
		console.log("clockIn:", btns.clockIn);
		console.log("breakStart:", btns.breakStart);
		console.log("breakEnd:", btns.breakEnd);
		console.log("clockOut:", btns.clockOut);

	    const employeeId = "yao001";  //  ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®IDã€‚ä»Šã¯å›ºå®šå€¤ã¨ã—ã¦ä½¿ç”¨
	    const endpoints = {
			start: { url: "/attendance/start", method: "POST", next: "/attendance/clockin-page" },
		    breakStart: { url: "/attendance/breakStart", method: "POST", next: "/attendance/breakstart-page" },
		    breakEnd: { url: "/attendance/breakEnd", method: "POST", next: "/attendance/breakend-page" },
		    end: { url: "/attendance/end", method: "POST", next: "/attendance/clockout-page" }
	    };

		// åˆæœŸçŠ¶æ…‹ã‚’ sessionStorage ã‹ã‚‰å¾©å…ƒ
		const stage = sessionStorage.getItem("stage");

		if (stage === "clockInDone") {
		    setButtonState(["breakStart", "clockOut"]);
		} else if (stage === "breakStarted") {
		    setButtonState(["breakEnd"]);
		} else if (stage === "breakEnded") {
		    setButtonState(["clockOut"]);
		} else {
		    // åˆæœŸçŠ¶æ…‹ï¼ˆæœªå‡ºå‹¤ï¼‰
		    setButtonState(["clockIn"]);
		}
		console.log("âœ… setButtonState(['start']) å®Ÿè¡Œæ¸ˆã¿");


		function setButtonState(enabledKeys = []) {
			console.log("ğŸ”§ setButtonState å‘¼ã³å‡ºã—:", enabledKeys);
			
		    Object.keys(btns).forEach(key => {
		        const btn = btns[key];
		        const isEnabled = enabledKeys.includes(key); 
		        btn.disabled = !isEnabled;
		        //btn.classList.toggle("disabled", btn.disabled);
				console.log(`  â†’ ${key} ãƒœã‚¿ãƒ³: ${isEnabled ? "æœ‰åŠ¹" : "ç„¡åŠ¹"}`);
		    });
		}

	    function showError(msg) {
	        alert("ã‚¨ãƒ©ãƒ¼: " + msg);
	    }

	    function getCategoryId() {
	        return document.querySelector('input[name="option"]:checked')?.value || "0";
	    }

		function doAction(actionKey, onSuccess) {
		    const { url, method, next } = endpoints[actionKey];

		    const formData = new URLSearchParams();
		    formData.append("employeeId", employeeId);
		    if (actionKey === "start") {
		        formData.append("categoryId", getCategoryId());
		    }

		    fetch(url, {
		        method,
		        headers: { "Content-Type": "application/x-www-form-urlencoded" },
		        body: formData.toString()
		    })
		    .then(res => {
		        if (!res.ok) return res.text().then(text => { throw new Error(text); });

		        const now = new Date().toLocaleString("ja-JP", { hour12: false });
		        sessionStorage.setItem("lastTime", now);

		        // ä¿å­˜ stage 
		        if (actionKey === "start") {
		            sessionStorage.setItem("stage", "clockInDone");
		        } else if (actionKey === "breakStart") {
		            sessionStorage.setItem("stage", "breakStarted");
		        } else if (actionKey === "breakEnd") {
		            sessionStorage.setItem("stage", "breakEnded");
		        } else if (actionKey === "end") {
		            sessionStorage.setItem("stage", "clockOutDone");
		        }

		        if (typeof onSuccess === "function") {
		            onSuccess();
		        }

		        window.location.href = next;
		    })
		    .catch(err => {
		        console.error("APIã‚¨ãƒ©ãƒ¼", err);
		        showError(err.message || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
		    });
		}

	    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
		btns.clockIn.addEventListener("click", () => {
		    doAction("start", () => {
		        setButtonState(["breakStart", "clockOut"]);
		    });
		});

	    btns.breakStart.addEventListener("click", () => {
	        doAction("breakStart");
	        setButtonState(["breakEnd"]);
	    });

	    btns.breakEnd.addEventListener("click", () => {
	        doAction("breakEnd");
	        setButtonState(["clockOut"]);
	    });

	    btns.clockOut.addEventListener("click", () => {
	        doAction("end");
	        setButtonState(["clockIn"]);
	    });

	    // ç¾åœ¨æ™‚åˆ»è¡¨ç¤º
	    const dateEl = document.getElementById("date");
	    const timeEl = document.getElementById("time");
	    function updateClock() {
	        const now = new Date();
	        dateEl.textContent = now.toLocaleDateString("ja-JP");
	        timeEl.textContent = now.toLocaleTimeString("ja-JP");
	    }
	    updateClock();
	    setInterval(updateClock, 1000);
	});
</script>
</body>
</html>




