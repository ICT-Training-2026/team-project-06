<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>Timinute</title>
  <link rel="stylesheet" href="../css/header.css">
  <link rel="stylesheet" href="../css/AttendanceConfirmation.css" />
</head>

<body>

  <header class="header">
    <div class="logo-container">
      <img src="../image/Timinute_logo.png" alt="画像">
    </div>
    <div class="welcome-text">
		<p>
			お疲れ様です！<br>
			<span th:text="${session.Name}">ユーザー</span>さん
		</p>
    </div>
    <div class="buttons">
		<a href="/userhomepage"><button class="headerbtn">HOME</button></a>
		<form th:action="@{/logout}" method="post" style="display: inline;">
			<button class="headerbtn" type="submit">Logout</button>
		</form>
    </div>
  </header>

  <div class="whole">
    <confirmation class="confirmation">
      <div class="period">
        <div class="date">
          <h3>期間</h3>
          <form>
            <label for="start-date"></label>
            <input type="date" id="start-date" name="start-date">
            <div class="fontp">
              <p>~</p>
            </div>
            <label for="end-date"></label>
            <input type="date" id="end-date" name="end-date">
          </form>
        </div>
      </div>
      <div class="buttons">
        <button class="btn" id="searchBtn">検索</button>
      </div>
    </confirmation>

  </div>
	<div id="resultContainer">
  	  <table id="resultTable">
  	    <thead>
  	      <tr>
  	        <th>日付</th>
  	        <th>出勤時刻</th>
  	        <th>退勤時刻</th>
  	        <th>休憩開始</th>
  	        <th>休憩終了</th>
  	        <th>勤務時間</th>
  	        <th>休憩時間</th>
  	        <th>勤務区分</th>
  	        <th>状態</th>
  	      </tr>
  	    </thead>
  	    <tbody>
  	      <!-- ここにデータを追加 -->
  	    </tbody>
  	  </table>
  	</div>


  <script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('dateForm');
  const startDateInput = document.getElementById('start-date');
  const endDateInput = document.getElementById('end-date');
  const errorMessage = document.getElementById('error-message');
  const searchButton = document.getElementById('searchBtn');

  searchButton.addEventListener('click', function (event) {
    event.preventDefault(); // ボタンのデフォルトの動作を防ぐ

    // 開始日と終了日の値を取得
    const startDateValue = startDateInput.value;
    const endDateValue = endDateInput.value;

    // 日付が選択されていない場合のチェック
    if (!startDateValue || !endDateValue) {
      alert('日付を選択してください。');
      return;
    }

    // 日付の比較
    const startDate = new Date(startDateValue);
    const endDate = new Date(endDateValue);

    if (startDate > endDate) {
      alert('開始日が終了日より後になっています。');
    } else {
      // 日付が正しく選択されている場合
      //alert('検索を開始します。\n開始日: ' + startDateValue + '\n終了日: ' + endDateValue);

      // バックエンドにPOSTリクエストを送信
      fetch('/attendance/api/search', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          startDate: startDateValue,
          endDate: endDateValue
        })
      })
      .then(response => response.json())
	  .then(data => {
	    console.log('Success:', data);
	    //alert('検索が完了しました。結果を確認してください。');

	    const tableBody = document.querySelector("#resultTable tbody");
	    tableBody.innerHTML = ""; // 既存行をクリア

	    if (data.length === 0) {
	      tableBody.innerHTML = "<tr><td colspan='9'>該当データがありません</td></tr>";
	      return;
	    }

		// 勤務区分のマッピング
		const categoryMap = {
		  0: '出勤',
		  1: '振出',
		  2: '振休',
		  3: '年休',
		  4: '休日',
		  5: '欠勤'
		};

		// 状態のマッピング
		const statusMap = {
		  0: '出勤',
		  1: '退勤',
		  2: '休憩'
		};

	    data.forEach(item => {
	      const row = document.createElement("tr");
	      row.innerHTML = `
	        <td>${item.date || ""}</td>
	        <td>${item.startTime || ""}</td>
	        <td>${item.closingTime || ""}</td>
	        <td>${item.startBreakTime || ""}</td>
	        <td>${item.endBreakTime || ""}</td>
	        <td>${item.workTime || ""}</td>
	        <td>${item.breakTime || ""}</td>
			<td>${categoryMap[item.categoryId] ?? item.categoryId}</td>
			<td>${statusMap[item.statusId] ?? item.statusId}</td>
	      `;
	      tableBody.appendChild(row);
	    });
	  })
      .catch((error) => {
        console.error('Error:', error);
        alert('検索中にエラーが発生しました。');
      });
    }
  });
});
</script>

</body>

</html>